(window["visTypeVega_bundle_jsonpfunction"]=window["visTypeVega_bundle_jsonpfunction"]||[]).push([[5],{40:function(module,exports){module.exports=function(e){const[n,o]=/\/schema\/([\w-]+)\/([\w\.\-]+)\.json$/g.exec(e).slice(1,3);return{library:n,version:o}}},41:function(module,exports,__webpack_require__){var __WEBPACK_AMD_DEFINE_FACTORY__,__WEBPACK_AMD_DEFINE_ARRAY__,__WEBPACK_AMD_DEFINE_RESULT__;(function(root,factory){if(true){!(__WEBPACK_AMD_DEFINE_ARRAY__=[],__WEBPACK_AMD_DEFINE_FACTORY__=factory,__WEBPACK_AMD_DEFINE_RESULT__=typeof __WEBPACK_AMD_DEFINE_FACTORY__==="function"?__WEBPACK_AMD_DEFINE_FACTORY__.apply(exports,__WEBPACK_AMD_DEFINE_ARRAY__):__WEBPACK_AMD_DEFINE_FACTORY__,__WEBPACK_AMD_DEFINE_RESULT__!==undefined&&(module.exports=__WEBPACK_AMD_DEFINE_RESULT__))}else{}})(this,(function(){var semver=/^v?(?:\d+)(\.(?:[x*]|\d+)(\.(?:[x*]|\d+)(\.(?:[x*]|\d+))?(?:-[\da-z\-]+(?:\.[\da-z\-]+)*)?(?:\+[\da-z\-]+(?:\.[\da-z\-]+)*)?)?)?$/i;function indexOrEnd(str,q){return str.indexOf(q)===-1?str.length:str.indexOf(q)}function split(v){var c=v.replace(/^v/,"").replace(/\+.*$/,"");var patchIndex=indexOrEnd(c,"-");var arr=c.substring(0,patchIndex).split(".");arr.push(c.substring(patchIndex+1));return arr}function tryParse(v){return isNaN(Number(v))?v:Number(v)}function validate(version){if(typeof version!=="string"){throw new TypeError("Invalid argument expected string")}if(!semver.test(version)){throw new Error("Invalid argument not valid semver ('"+version+"' received)")}}function compareVersions(v1,v2){[v1,v2].forEach(validate);var s1=split(v1);var s2=split(v2);for(var i=0;i<Math.max(s1.length-1,s2.length-1);i++){var n1=parseInt(s1[i]||0,10);var n2=parseInt(s2[i]||0,10);if(n1>n2)return 1;if(n2>n1)return-1}var sp1=s1[s1.length-1];var sp2=s2[s2.length-1];if(sp1&&sp2){var p1=sp1.split(".").map(tryParse);var p2=sp2.split(".").map(tryParse);for(i=0;i<Math.max(p1.length,p2.length);i++){if(p1[i]===undefined||typeof p2[i]==="string"&&typeof p1[i]==="number")return-1;if(p2[i]===undefined||typeof p1[i]==="string"&&typeof p2[i]==="number")return 1;if(p1[i]>p2[i])return 1;if(p2[i]>p1[i])return-1}}else if(sp1||sp2){return sp1?-1:1}return 0}var allowedOperators=[">",">=","=","<","<="];var operatorResMap={">":[1],">=":[0,1],"=":[0],"<=":[-1,0],"<":[-1]};function validateOperator(op){if(typeof op!=="string"){throw new TypeError("Invalid operator type, expected string but got "+typeof op)}if(allowedOperators.indexOf(op)===-1){throw new TypeError("Invalid operator, expected one of "+allowedOperators.join("|"))}}compareVersions.compare=function(v1,v2,operator){validateOperator(operator);var res=compareVersions(v1,v2);return operatorResMap[operator].indexOf(res)>-1};return compareVersions}))},79:function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__);__webpack_require__.d(__webpack_exports__,"VegaParser",(function(){return vega_parser_VegaParser}));var external_kbnSharedDeps_Lodash_=__webpack_require__(9);var external_kbnSharedDeps_Lodash_default=__webpack_require__.n(external_kbnSharedDeps_Lodash_);var dist_parser=__webpack_require__(40);var parser_default=__webpack_require__.n(dist_parser);var compare_versions=__webpack_require__(41);var compare_versions_default=__webpack_require__.n(compare_versions);var hjson=__webpack_require__(14);var hjson_default=__webpack_require__.n(hjson);var external_kbnSharedDeps_ElasticEui_=__webpack_require__(7);var external_kbnSharedDeps_Theme_=__webpack_require__(30);var external_kbnSharedDeps_KbnI18n_=__webpack_require__(2);var vega=__webpack_require__(33);var external_kbnSharedDeps_Moment_=__webpack_require__(27);var external_kbnSharedDeps_Moment_default=__webpack_require__.n(external_kbnSharedDeps_Moment_);function ownKeys(object,enumerableOnly){var keys=Object.keys(object);if(Object.getOwnPropertySymbols){var symbols=Object.getOwnPropertySymbols(object);if(enumerableOnly)symbols=symbols.filter((function(sym){return Object.getOwnPropertyDescriptor(object,sym).enumerable}));keys.push.apply(keys,symbols)}return keys}function _objectSpread(target){for(var i=1;i<arguments.length;i++){var source=arguments[i]!=null?arguments[i]:{};if(i%2){ownKeys(Object(source),true).forEach((function(key){_defineProperty(target,key,source[key])}))}else if(Object.getOwnPropertyDescriptors){Object.defineProperties(target,Object.getOwnPropertyDescriptors(source))}else{ownKeys(Object(source)).forEach((function(key){Object.defineProperty(target,key,Object.getOwnPropertyDescriptor(source,key))}))}}return target}function asyncGeneratorStep(gen,resolve,reject,_next,_throw,key,arg){try{var info=gen[key](arg);var value=info.value}catch(error){reject(error);return}if(info.done){resolve(value)}else{Promise.resolve(value).then(_next,_throw)}}function _asyncToGenerator(fn){return function(){var self=this,args=arguments;return new Promise((function(resolve,reject){var gen=fn.apply(self,args);function _next(value){asyncGeneratorStep(gen,resolve,reject,_next,_throw,"next",value)}function _throw(err){asyncGeneratorStep(gen,resolve,reject,_next,_throw,"throw",err)}_next(undefined)}))}}function _defineProperty(obj,key,value){if(key in obj){Object.defineProperty(obj,key,{value:value,enumerable:true,configurable:true,writable:true})}else{obj[key]=value}return obj}const TIMEFILTER="%timefilter%";const AUTOINTERVAL="%autointerval%";const MUST_CLAUSE="%dashboard_context-must_clause%";const MUST_NOT_CLAUSE="%dashboard_context-must_not_clause%";const FILTER_CLAUSE="%dashboard_context-filter_clause%";const LEGACY_CONTEXT="%context_query%";const CONTEXT="%context%";const TIMEFIELD="%timefield%";const getRequestName=(request,index)=>request.dataObject.name||external_kbnSharedDeps_KbnI18n_["i18n"].translate("visTypeVega.esQueryParser.unnamedRequest",{defaultMessage:"Unnamed request #{index}",values:{index:index}});class es_query_parser_EsQueryParser{constructor(timeCache,searchAPI,filters,onWarning){_defineProperty(this,"_timeCache",void 0);_defineProperty(this,"_searchAPI",void 0);_defineProperty(this,"_filters",void 0);_defineProperty(this,"_onWarning",void 0);this._timeCache=timeCache;this._searchAPI=searchAPI;this._filters=filters;this._onWarning=onWarning}parseUrl(dataObject,url){let body=url.body;let context=url[CONTEXT];delete url[CONTEXT];let timefield=url[TIMEFIELD];delete url[TIMEFIELD];let usesContext=context!==undefined||timefield!==undefined;if(body===undefined){url.body=body={}}else if(!Object(external_kbnSharedDeps_Lodash_["isPlainObject"])(body)){throw new Error(external_kbnSharedDeps_KbnI18n_["i18n"].translate("visTypeVega.esQueryParser.urlBodyValueTypeErrorMessage",{defaultMessage:"{configName} must be an object",values:{configName:"url.body"}}))}const legacyContext=url[LEGACY_CONTEXT];delete url[LEGACY_CONTEXT];if(legacyContext!==undefined){if(body.query!==undefined){throw new Error(external_kbnSharedDeps_KbnI18n_["i18n"].translate("visTypeVega.esQueryParser.dataUrlMustNotHaveLegacyAndBodyQueryValuesAtTheSameTimeErrorMessage",{defaultMessage:"{dataUrlParam} must not have legacy {legacyContext} and {bodyQueryConfigName} values at the same time",values:{legacyContext:'"'.concat(LEGACY_CONTEXT,'"'),bodyQueryConfigName:'"body.query"',dataUrlParam:'"data.url"'}}))}else if(usesContext){throw new Error(external_kbnSharedDeps_KbnI18n_["i18n"].translate("visTypeVega.esQueryParser.dataUrlMustNotHaveLegacyContextTogetherWithContextOrTimefieldErrorMessage",{defaultMessage:"{dataUrlParam} must not have {legacyContext} together with {context} or {timefield}",values:{legacyContext:'"'.concat(LEGACY_CONTEXT,'"'),context:'"'.concat(CONTEXT,'"'),timefield:'"'.concat(TIMEFIELD,'"'),dataUrlParam:'"data.url"'}}))}else if(legacyContext!==true&&(typeof legacyContext!=="string"||legacyContext.length===0)){throw new Error(external_kbnSharedDeps_KbnI18n_["i18n"].translate("visTypeVega.esQueryParser.legacyContextCanBeTrueErrorMessage",{defaultMessage:"Legacy {legacyContext} can either be {trueValue} (ignores time range picker), or it can be the name of the time field, e.g. {timestampParam}",values:{legacyContext:'"'.concat(LEGACY_CONTEXT,'"'),trueValue:"true",timestampParam:'"@timestamp"'}}))}usesContext=true;context=true;let result='"url": {"'.concat(CONTEXT,'": true');if(typeof legacyContext==="string"){timefield=legacyContext;result+=', "'.concat(TIMEFIELD,'": ').concat(JSON.stringify(timefield))}result+="}";this._onWarning(external_kbnSharedDeps_KbnI18n_["i18n"].translate("visTypeVega.esQueryParser.legacyUrlShouldChangeToWarningMessage",{defaultMessage:"Legacy {urlParam}: {legacyUrl} should change to {result}",values:{legacyUrl:'"'.concat(LEGACY_CONTEXT,'": ').concat(JSON.stringify(legacyContext)),result:result,urlParam:'"url"'}}))}if(body.query!==undefined){if(usesContext){throw new Error(external_kbnSharedDeps_KbnI18n_["i18n"].translate("visTypeVega.esQueryParser.urlContextAndUrlTimefieldMustNotBeUsedErrorMessage",{defaultMessage:"{urlContext} and {timefield} must not be used when {queryParam} is set",values:{timefield:"url.".concat(TIMEFIELD),urlContext:"url.".concat(CONTEXT),queryParam:"url.body.query"}}))}this._injectContextVars(body.query,true)}else if(usesContext){if(timefield){body.query={range:{[timefield]:this._createRangeFilter({[TIMEFILTER]:true})}}}if(context){const newQuery=Object(external_kbnSharedDeps_Lodash_["cloneDeep"])(this._filters);if(timefield){newQuery.bool.must.push(body.query)}body.query=newQuery}}this._injectContextVars(body.aggs,false);return{dataObject:dataObject,url:url}}populateData(requests){var _this=this;return _asyncToGenerator(regeneratorRuntime.mark((function _callee(){var esSearches,data$,results;return regeneratorRuntime.wrap((function _callee$(_context){while(1)switch(_context.prev=_context.next){case 0:esSearches=requests.map((r,index)=>_objectSpread(_objectSpread({},r.url),{},{name:getRequestName(r,index)}));data$=_this._searchAPI.search(esSearches);_context.next=4;return data$.toPromise();case 4:results=_context.sent;results.forEach((data,index)=>{const requestObject=requests.find(item=>getRequestName(item,index)===data.name);if(requestObject){requestObject.dataObject.values=data.rawResponse}});case 6:case"end":return _context.stop()}}),_callee)})))()}_injectContextVars(obj,isQuery){if(obj&&typeof obj==="object"){if(Array.isArray(obj)){for(let pos=0;pos<obj.length;){const item=obj[pos];if(isQuery&&(item===FILTER_CLAUSE||item===MUST_CLAUSE||item===MUST_NOT_CLAUSE)){let ctxTag="";switch(item){case FILTER_CLAUSE:ctxTag="filter";break;case MUST_CLAUSE:ctxTag="must";break;case MUST_NOT_CLAUSE:ctxTag="must_not";break}const ctx=Object(external_kbnSharedDeps_Lodash_["cloneDeep"])(this._filters);if(ctx&&ctx.bool&&ctx.bool[ctxTag]){if(Array.isArray(ctx.bool[ctxTag])){obj.splice(pos,1,...ctx.bool[ctxTag]);pos+=ctx.bool[ctxTag].length}else{obj[pos++]=ctx.bool[ctxTag]}}else{obj.splice(pos,1)}}else{this._injectContextVars(item,isQuery);pos++}}}else{for(var _i=0,_Object$keys=Object.keys(obj);_i<_Object$keys.length;_i++){const prop=_Object$keys[_i];const subObj=obj[prop];if(!subObj||typeof obj!=="object")continue;if(prop==="interval"&&subObj[AUTOINTERVAL]){let size=subObj[AUTOINTERVAL];if(size===true){size=50}else if(typeof size!=="number"){throw new Error(external_kbnSharedDeps_KbnI18n_["i18n"].translate("visTypeVega.esQueryParser.autointervalValueTypeErrorMessage",{defaultMessage:"{autointerval} must be either {trueValue} or a number",values:{autointerval:'"'.concat(AUTOINTERVAL,'"'),trueValue:"true"}}))}const bounds=this._timeCache.getTimeBounds();obj.interval=es_query_parser_EsQueryParser._roundInterval((bounds.max-bounds.min)/size);continue}switch(subObj[TIMEFILTER]){case"min":case"max":obj[prop]=this._getTimeBound(subObj,subObj[TIMEFILTER]);continue;case true:this._createRangeFilter(subObj);continue;case undefined:this._injectContextVars(subObj,isQuery);continue;default:throw new Error(external_kbnSharedDeps_KbnI18n_["i18n"].translate("visTypeVega.esQueryParser.timefilterValueErrorMessage",{defaultMessage:"{timefilter} property must be set to {trueValue}, {minValue}, or {maxValue}",values:{timefilter:'"'.concat(TIMEFILTER,'"'),trueValue:"true",minValue:'"min"',maxValue:'"max"'}}))}}}}}_createRangeFilter(obj){obj.gte=external_kbnSharedDeps_Moment_default()(this._getTimeBound(obj,"min")).toISOString();obj.lte=external_kbnSharedDeps_Moment_default()(this._getTimeBound(obj,"max")).toISOString();obj.format="strict_date_optional_time";delete obj[TIMEFILTER];delete obj.shift;delete obj.unit;return obj}_getTimeBound(opts,type){var _bounds$type;const bounds=this._timeCache.getTimeBounds();let result=((_bounds$type=bounds[type])===null||_bounds$type===void 0?void 0:_bounds$type.valueOf())||0;if(opts.shift){const shift=opts.shift;if(typeof shift!=="number"){throw new Error(external_kbnSharedDeps_KbnI18n_["i18n"].translate("visTypeVega.esQueryParser.shiftMustValueTypeErrorMessage",{defaultMessage:"{shiftParam} must be a numeric value",values:{shiftParam:'"shift"'}}))}let multiplier;switch(opts.unit||"d"){case"w":case"week":multiplier=1e3*60*60*24*7;break;case"d":case"day":multiplier=1e3*60*60*24;break;case"h":case"hour":multiplier=1e3*60*60;break;case"m":case"minute":multiplier=1e3*60;break;case"s":case"second":multiplier=1e3;break;default:throw new Error(external_kbnSharedDeps_KbnI18n_["i18n"].translate("visTypeVega.esQueryParser.unknownUnitValueErrorMessage",{defaultMessage:"Unknown {unitParamName} value. Must be one of: [{unitParamValues}]",values:{unitParamName:'"unit"',unitParamValues:'"week", "day", "hour", "minute", "second"'}}))}result+=shift*multiplier}return result}static _roundInterval(interval){switch(true){case interval<=500:return"100ms";case interval<=5e3:return"1s";case interval<=7500:return"5s";case interval<=15e3:return"10s";case interval<=45e3:return"30s";case interval<=18e4:return"1m";case interval<=45e4:return"5m";case interval<=12e5:return"10m";case interval<=27e5:return"30m";case interval<=72e5:return"1h";case interval<=216e5:return"3h";case interval<=864e5:return"12h";case interval<=6048e5:return"24h";case interval<=18144e5:return"1w";case interval<36288e5:return"30d";default:return"1y"}}}var utils=__webpack_require__(39);var vega_base_view=__webpack_require__(35);function _createForOfIteratorHelper(o,allowArrayLike){var it;if(typeof Symbol==="undefined"||o[Symbol.iterator]==null){if(Array.isArray(o)||(it=_unsupportedIterableToArray(o))||allowArrayLike&&o&&typeof o.length==="number"){if(it)o=it;var i=0;var F=function F(){};return{s:F,n:function n(){if(i>=o.length)return{done:true};return{done:false,value:o[i++]}},e:function e(_e){throw _e},f:F}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var normalCompletion=true,didErr=false,err;return{s:function s(){it=o[Symbol.iterator]()},n:function n(){var step=it.next();normalCompletion=step.done;return step},e:function e(_e2){didErr=true;err=_e2},f:function f(){try{if(!normalCompletion&&it.return!=null)it.return()}finally{if(didErr)throw err}}}}function _unsupportedIterableToArray(o,minLen){if(!o)return;if(typeof o==="string")return _arrayLikeToArray(o,minLen);var n=Object.prototype.toString.call(o).slice(8,-1);if(n==="Object"&&o.constructor)n=o.constructor.name;if(n==="Map"||n==="Set")return Array.from(o);if(n==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return _arrayLikeToArray(o,minLen)}function _arrayLikeToArray(arr,len){if(len==null||len>arr.length)len=arr.length;for(var i=0,arr2=new Array(len);i<len;i++)arr2[i]=arr[i];return arr2}function ems_file_parser_asyncGeneratorStep(gen,resolve,reject,_next,_throw,key,arg){try{var info=gen[key](arg);var value=info.value}catch(error){reject(error);return}if(info.done){resolve(value)}else{Promise.resolve(value).then(_next,_throw)}}function ems_file_parser_asyncToGenerator(fn){return function(){var self=this,args=arguments;return new Promise((function(resolve,reject){var gen=fn.apply(self,args);function _next(value){ems_file_parser_asyncGeneratorStep(gen,resolve,reject,_next,_throw,"next",value)}function _throw(err){ems_file_parser_asyncGeneratorStep(gen,resolve,reject,_next,_throw,"throw",err)}_next(undefined)}))}}function ems_file_parser_defineProperty(obj,key,value){if(key in obj){Object.defineProperty(obj,key,{value:value,enumerable:true,configurable:true,writable:true})}else{obj[key]=value}return obj}class ems_file_parser_EmsFileParser{constructor(serviceSettings){ems_file_parser_defineProperty(this,"_serviceSettings",void 0);ems_file_parser_defineProperty(this,"_fileLayersP",void 0);this._serviceSettings=serviceSettings}parseUrl(obj,url){if(typeof url.name!=="string"){throw new Error(external_kbnSharedDeps_KbnI18n_["i18n"].translate("visTypeVega.emsFileParser.missingNameOfFileErrorMessage",{defaultMessage:"{dataUrlParam} with {dataUrlParamValue} requires {nameParam} parameter (name of the file)",values:{dataUrlParam:'"data.url"',dataUrlParamValue:'{"%type%": "emsfile"}',nameParam:'"name"'}}))}if(!this._fileLayersP){this._fileLayersP=this._serviceSettings.getFileLayers()}return{obj:obj,name:url.name}}populateData(requests){var _this=this;return ems_file_parser_asyncToGenerator(regeneratorRuntime.mark((function _callee(){var layers,_iterator,_step,_step$value,obj,name,foundLayer,url;return regeneratorRuntime.wrap((function _callee$(_context){while(1)switch(_context.prev=_context.next){case 0:if(!(requests.length===0)){_context.next=2;break}return _context.abrupt("return");case 2:_context.next=4;return _this._fileLayersP;case 4:layers=_context.sent;_iterator=_createForOfIteratorHelper(requests);_context.prev=6;_iterator.s();case 8:if((_step=_iterator.n()).done){_context.next=19;break}_step$value=_step.value,obj=_step$value.obj,name=_step$value.name;foundLayer=layers===null||layers===void 0?void 0:layers.find(v=>v.name===name);if(foundLayer){_context.next=13;break}throw new Error(external_kbnSharedDeps_KbnI18n_["i18n"].translate("visTypeVega.emsFileParser.emsFileNameDoesNotExistErrorMessage",{defaultMessage:"{emsfile} {emsfileName} does not exist",values:{emsfileName:JSON.stringify(name),emsfile:"emsfile"}}));case 13:_context.next=15;return _this._serviceSettings.getUrlForRegionLayer(foundLayer);case 15:url=_context.sent;obj.url=Object(vega_base_view["b"])(url);case 17:_context.next=8;break;case 19:_context.next=24;break;case 21:_context.prev=21;_context.t0=_context["catch"](6);_iterator.e(_context.t0);case 24:_context.prev=24;_iterator.f();return _context.finish(24);case 27:case"end":return _context.stop()}}),_callee,null,[[6,21,24,27]])})))()}}var external_kbnSharedDeps_Jquery_=__webpack_require__(28);var external_kbnSharedDeps_Jquery_default=__webpack_require__.n(external_kbnSharedDeps_Jquery_);function url_parser_defineProperty(obj,key,value){if(key in obj){Object.defineProperty(obj,key,{value:value,enumerable:true,configurable:true,writable:true})}else{obj[key]=value}return obj}class url_parser_UrlParser{constructor(onWarning){url_parser_defineProperty(this,"_onWarning",void 0);this._onWarning=onWarning}parseUrl(obj,urlObj){let url=urlObj.url;if(!url){throw new Error(external_kbnSharedDeps_KbnI18n_["i18n"].translate("visTypeVega.urlParser.dataUrlRequiresUrlParameterInFormErrorMessage",{defaultMessage:'{dataUrlParam} requires a {urlParam} parameter in a form "{formLink}"',values:{dataUrlParam:'"data.url"',urlParam:'"url"',formLink:"https://example.org/path/subpath"}}))}const query=urlObj.query;if(!query){this._onWarning(external_kbnSharedDeps_KbnI18n_["i18n"].translate("visTypeVega.urlParser.urlShouldHaveQuerySubObjectWarningMessage",{defaultMessage:"Using a {urlObject} should have a {subObjectName} sub-object",values:{urlObject:'"url": {"%type%": "url", "url": ...}',subObjectName:'"query"'}}))}else{url+=(url.includes("?")?"&":"?")+external_kbnSharedDeps_Jquery_default.a.param(query)}obj.url=url}populateData(){}}function vega_parser_createForOfIteratorHelper(o,allowArrayLike){var it;if(typeof Symbol==="undefined"||o[Symbol.iterator]==null){if(Array.isArray(o)||(it=vega_parser_unsupportedIterableToArray(o))||allowArrayLike&&o&&typeof o.length==="number"){if(it)o=it;var i=0;var F=function F(){};return{s:F,n:function n(){if(i>=o.length)return{done:true};return{done:false,value:o[i++]}},e:function e(_e){throw _e},f:F}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var normalCompletion=true,didErr=false,err;return{s:function s(){it=o[Symbol.iterator]()},n:function n(){var step=it.next();normalCompletion=step.done;return step},e:function e(_e2){didErr=true;err=_e2},f:function f(){try{if(!normalCompletion&&it.return!=null)it.return()}finally{if(didErr)throw err}}}}function vega_parser_unsupportedIterableToArray(o,minLen){if(!o)return;if(typeof o==="string")return vega_parser_arrayLikeToArray(o,minLen);var n=Object.prototype.toString.call(o).slice(8,-1);if(n==="Object"&&o.constructor)n=o.constructor.name;if(n==="Map"||n==="Set")return Array.from(o);if(n==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return vega_parser_arrayLikeToArray(o,minLen)}function vega_parser_arrayLikeToArray(arr,len){if(len==null||len>arr.length)len=arr.length;for(var i=0,arr2=new Array(len);i<len;i++)arr2[i]=arr[i];return arr2}function vega_parser_ownKeys(object,enumerableOnly){var keys=Object.keys(object);if(Object.getOwnPropertySymbols){var symbols=Object.getOwnPropertySymbols(object);if(enumerableOnly)symbols=symbols.filter((function(sym){return Object.getOwnPropertyDescriptor(object,sym).enumerable}));keys.push.apply(keys,symbols)}return keys}function vega_parser_objectSpread(target){for(var i=1;i<arguments.length;i++){var source=arguments[i]!=null?arguments[i]:{};if(i%2){vega_parser_ownKeys(Object(source),true).forEach((function(key){vega_parser_defineProperty(target,key,source[key])}))}else if(Object.getOwnPropertyDescriptors){Object.defineProperties(target,Object.getOwnPropertyDescriptors(source))}else{vega_parser_ownKeys(Object(source)).forEach((function(key){Object.defineProperty(target,key,Object.getOwnPropertyDescriptor(source,key))}))}}return target}function vega_parser_asyncGeneratorStep(gen,resolve,reject,_next,_throw,key,arg){try{var info=gen[key](arg);var value=info.value}catch(error){reject(error);return}if(info.done){resolve(value)}else{Promise.resolve(value).then(_next,_throw)}}function vega_parser_asyncToGenerator(fn){return function(){var self=this,args=arguments;return new Promise((function(resolve,reject){var gen=fn.apply(self,args);function _next(value){vega_parser_asyncGeneratorStep(gen,resolve,reject,_next,_throw,"next",value)}function _throw(err){vega_parser_asyncGeneratorStep(gen,resolve,reject,_next,_throw,"throw",err)}_next(undefined)}))}}function vega_parser_defineProperty(obj,key,value){if(key in obj){Object.defineProperty(obj,key,{value:value,enumerable:true,configurable:true,writable:true})}else{obj[key]=value}return obj}const defaultColor=Object(external_kbnSharedDeps_ElasticEui_["euiPaletteColorBlind"])()[0];const locToDirMap={left:"row-reverse",right:"row",top:"column-reverse",bottom:"column"};const DEFAULT_PARSER="elasticsearch";class vega_parser_VegaParser{constructor(spec,searchAPI,timeCache,filters,getServiceSettings){vega_parser_defineProperty(this,"spec",void 0);vega_parser_defineProperty(this,"hideWarnings",void 0);vega_parser_defineProperty(this,"error",void 0);vega_parser_defineProperty(this,"warnings",void 0);vega_parser_defineProperty(this,"_urlParsers",void 0);vega_parser_defineProperty(this,"isVegaLite",void 0);vega_parser_defineProperty(this,"useHover",void 0);vega_parser_defineProperty(this,"_config",void 0);vega_parser_defineProperty(this,"useMap",void 0);vega_parser_defineProperty(this,"renderer",void 0);vega_parser_defineProperty(this,"tooltips",void 0);vega_parser_defineProperty(this,"mapConfig",void 0);vega_parser_defineProperty(this,"vlspec",void 0);vega_parser_defineProperty(this,"useResize",void 0);vega_parser_defineProperty(this,"containerDir",void 0);vega_parser_defineProperty(this,"controlsDir",void 0);vega_parser_defineProperty(this,"searchAPI",void 0);vega_parser_defineProperty(this,"getServiceSettings",void 0);vega_parser_defineProperty(this,"filters",void 0);vega_parser_defineProperty(this,"timeCache",void 0);this.spec=spec;this.hideWarnings=false;this.error=undefined;this.warnings=[];this.searchAPI=searchAPI;this.getServiceSettings=getServiceSettings;this.filters=filters;this.timeCache=timeCache}parseAsync(){var _this=this;return vega_parser_asyncToGenerator(regeneratorRuntime.mark((function _callee(){return regeneratorRuntime.wrap((function _callee$(_context){while(1)switch(_context.prev=_context.next){case 0:_context.prev=0;_context.next=3;return _this._parseAsync();case 3:_context.next=8;break;case 5:_context.prev=5;_context.t0=_context["catch"](0);_this.error=utils["a"].formatErrorToStr(_context.t0);case 8:return _context.abrupt("return",_this);case 9:case"end":return _context.stop()}}),_callee,null,[[0,5]])})))()}_parseAsync(){var _this2=this;return vega_parser_asyncToGenerator(regeneratorRuntime.mark((function _callee2(){var spec;return regeneratorRuntime.wrap((function _callee2$(_context2){while(1)switch(_context2.prev=_context2.next){case 0:if(!(_this2.isVegaLite!==undefined)){_context2.next=2;break}throw new Error;case 2:if(!(typeof _this2.spec==="string")){_context2.next=7;break}spec=hjson_default.a.parse(_this2.spec,{legacyRoot:false});if(spec.$schema){_context2.next=6;break}throw new Error(external_kbnSharedDeps_KbnI18n_["i18n"].translate("visTypeVega.vegaParser.inputSpecDoesNotSpecifySchemaErrorMessage",{defaultMessage:"Your specification requires a {schemaParam} field with a valid URL for\nVega (see {vegaSchemaUrl}) or\nVega-Lite (see {vegaLiteSchemaUrl}).\nThe URL is an identifier only. Kibana and your browser will never access this URL.",values:{schemaParam:'"$schema"',vegaLiteSchemaUrl:"https://vega.github.io/vega-lite/docs/spec.html#top-level",vegaSchemaUrl:"https://vega.github.io/vega/docs/specification/#top-level-specification-properties"}}));case 6:_this2.spec=spec;case 7:if(external_kbnSharedDeps_Lodash_default.a.isPlainObject(_this2.spec)){_context2.next=9;break}throw new Error(external_kbnSharedDeps_KbnI18n_["i18n"].translate("visTypeVega.vegaParser.invalidVegaSpecErrorMessage",{defaultMessage:"Invalid Vega specification"}));case 9:_this2.isVegaLite=_this2.parseSchema(_this2.spec).isVegaLite;_this2.useHover=!_this2.isVegaLite;_this2._config=_this2._parseConfig();_this2.hideWarnings=!!_this2._config.hideWarnings;_this2.useMap=_this2._config.type==="map";_this2.renderer=_this2._config.renderer==="svg"?"svg":"canvas";_this2.tooltips=_this2._parseTooltips();_this2._setDefaultColors();_this2._parseControlPlacement();if(_this2.useMap){_this2.mapConfig=_this2._parseMapConfig();_this2.useResize=false}else if(_this2.spec){_this2._compileWithAutosize()}_context2.next=21;return _this2._resolveDataUrls();case 21:if(_this2.isVegaLite){_this2._compileVegaLite()}case 22:case"end":return _context2.stop()}}),_callee2)})))()}_compileWithAutosize(){const defaultAutosize={type:"fit",contains:"padding"};let autosize=this.spec.autosize;let useResize=true;if(!this.isVegaLite&&autosize&&typeof autosize==="object"&&"signal"in autosize){return}if(!autosize&&typeof autosize!=="undefined"){this._onWarning(external_kbnSharedDeps_KbnI18n_["i18n"].translate("visTypeVega.vegaParser.autoSizeDoesNotAllowFalse",{defaultMessage:"{autoSizeParam} is enabled, it can only be disabled by setting {autoSizeParam} to {noneParam}",values:{autoSizeParam:'"autosize"',noneParam:'"none"'}}))}if(typeof autosize==="string"){useResize=autosize!=="none";autosize=vega_parser_objectSpread(vega_parser_objectSpread({},defaultAutosize),{},{type:autosize})}else if(typeof autosize==="object"){var _autosize,_autosize2;autosize=vega_parser_objectSpread(vega_parser_objectSpread({},defaultAutosize),autosize);useResize=Boolean(((_autosize=autosize)===null||_autosize===void 0?void 0:_autosize.type)&&((_autosize2=autosize)===null||_autosize2===void 0?void 0:_autosize2.type)!=="none")}else{autosize=defaultAutosize}if(useResize&&(this.spec.width&&this.spec.width!=="container"||this.spec.height&&this.spec.height!=="container")){this._onWarning(external_kbnSharedDeps_KbnI18n_["i18n"].translate("visTypeVega.vegaParser.widthAndHeightParamsAreIgnored",{defaultMessage:"{widthParam} and {heightParam} params are ignored because {autoSizeParam} is enabled. Set {autoSizeParam}: {noneParam} to disable",values:{widthParam:'"width"',heightParam:'"height"',autoSizeParam:'"autosize"',noneParam:'"none"'}}))}if(useResize){this.spec.width="container";this.spec.height="container"}this.spec.autosize=autosize;this.useResize=useResize}_compileVegaLite(){this.vlspec=this.spec;const logger=vega["a"].logger(vega["a"].Warn);logger.warn=this._onWarning.bind(this);this.spec=vega["b"].compile(this.vlspec,logger).spec;if(this.useMap){if(!this.spec||!this.vlspec)return;const hasConfig=external_kbnSharedDeps_Lodash_default.a.isPlainObject(this.vlspec.config);if(this.vlspec.config===undefined||hasConfig&&!this.vlspec.config.projection){if(!Array.isArray(this.spec.projections)||this.spec.projections.length!==1||this.spec.projections[0].name!=="projection"){throw new Error(external_kbnSharedDeps_KbnI18n_["i18n"].translate("visTypeVega.vegaParser.VLCompilerShouldHaveGeneratedSingleProtectionObjectErrorMessage",{defaultMessage:"Internal error: Vega-Lite compiler should have generated a single projection object"}))}delete this.spec.projections}if(!this.vlspec.width)delete this.spec.width;if(!this.vlspec.height)delete this.spec.height;if(!this.vlspec.padding&&(this.vlspec.config===undefined||hasConfig&&!this.vlspec.config.padding)){delete this.spec.padding}if(!this.vlspec.autosize&&(this.vlspec.config===undefined||hasConfig&&!this.vlspec.config.autosize)){delete this.spec.autosize}}}_parseControlPlacement(){var _this$_config,_this$_config2;this.containerDir=((_this$_config=this._config)===null||_this$_config===void 0?void 0:_this$_config.controlsLocation)?locToDirMap[this._config.controlsLocation]:undefined;if(this.containerDir===undefined){if(this._config&&this._config.controlsLocation===undefined){this.containerDir="column"}else{throw new Error(external_kbnSharedDeps_KbnI18n_["i18n"].translate("visTypeVega.vegaParser.unrecognizedControlsLocationValueErrorMessage",{defaultMessage:"Unrecognized {controlsLocationParam} value. Expecting one of [{locToDirMap}]",values:{locToDirMap:'"'.concat(Object.keys(locToDirMap).join('", "'),'"'),controlsLocationParam:"controlsLocation"}}))}}const dir=(_this$_config2=this._config)===null||_this$_config2===void 0?void 0:_this$_config2.controlsDirection;if(dir!==undefined&&dir!=="horizontal"&&dir!=="vertical"){throw new Error(external_kbnSharedDeps_KbnI18n_["i18n"].translate("visTypeVega.vegaParser.unrecognizedDirValueErrorMessage",{defaultMessage:"Unrecognized {dirParam} value. Expecting one of [{expectedValues}]",values:{expectedValues:'"horizontal", "vertical"',dirParam:"dir"}}))}this.controlsDir=dir==="horizontal"?"row":"column"}_parseConfig(){let result=null;if(this.spec){if(this.spec._hostConfig!==undefined){result=this.spec._hostConfig;delete this.spec._hostConfig;if(!external_kbnSharedDeps_Lodash_default.a.isPlainObject(result)){throw new Error(external_kbnSharedDeps_KbnI18n_["i18n"].translate("visTypeVega.vegaParser.hostConfigValueTypeErrorMessage",{defaultMessage:"If present, {configName} must be an object",values:{configName:'"_hostConfig"'}}))}this._onWarning(external_kbnSharedDeps_KbnI18n_["i18n"].translate("visTypeVega.vegaParser.hostConfigIsDeprecatedWarningMessage",{defaultMessage:"{deprecatedConfigName} has been deprecated. Use {newConfigName} instead.",values:{deprecatedConfigName:'"_hostConfig"',newConfigName:"config.kibana"}}))}if(external_kbnSharedDeps_Lodash_default.a.isPlainObject(this.spec.config)&&this.spec.config.kibana!==undefined){result=this.spec.config.kibana;delete this.spec.config.kibana;if(!external_kbnSharedDeps_Lodash_default.a.isPlainObject(result)){throw new Error(external_kbnSharedDeps_KbnI18n_["i18n"].translate("visTypeVega.vegaParser.kibanaConfigValueTypeErrorMessage",{defaultMessage:"If present, {configName} must be an object",values:{configName:"config.kibana"}}))}}}return result||{}}_parseTooltips(){var _this$_config3;if(this._config&&this._config.tooltips===false){return false}const result=((_this$_config3=this._config)===null||_this$_config3===void 0?void 0:_this$_config3.tooltips)||{};if(result.position===undefined){result.position="top"}else if(["top","right","bottom","left"].indexOf(result.position)===-1){throw new Error(external_kbnSharedDeps_KbnI18n_["i18n"].translate("visTypeVega.vegaParser.unexpectedValueForPositionConfigurationErrorMessage",{defaultMessage:"Unexpected value for the {configurationName} configuration",values:{configurationName:"result.position"}}))}if(result.padding===undefined){result.padding=16}else if(typeof result.padding!=="number"){throw new Error(external_kbnSharedDeps_KbnI18n_["i18n"].translate("visTypeVega.vegaParser.paddingConfigValueTypeErrorMessage",{defaultMessage:"{configName} is expected to be a number",values:{configName:"config.kibana.result.padding"}}))}if(result.textTruncate===undefined){result.textTruncate=false}else if(typeof result.textTruncate!=="boolean"){throw new Error(external_kbnSharedDeps_KbnI18n_["i18n"].translate("visTypeVega.vegaParser.textTruncateConfigValueTypeErrorMessage",{defaultMessage:"{configName} is expected to be a boolean",values:{configName:"textTruncate"}}))}if(result.centerOnMark===undefined){result.centerOnMark=50}else if(typeof result.centerOnMark==="boolean"){result.centerOnMark=result.centerOnMark?Number.MAX_VALUE:-1}else if(typeof result.centerOnMark!=="number"){throw new Error(external_kbnSharedDeps_KbnI18n_["i18n"].translate("visTypeVega.vegaParser.centerOnMarkConfigValueTypeErrorMessage",{defaultMessage:"{configName} is expected to be {trueValue}, {falseValue}, or a number",values:{configName:"config.kibana.result.centerOnMark",trueValue:"true",falseValue:"false"}}))}return result}_parseMapConfig(){var _this$_config4,_this$_config5,_this$_config6;const res={delayRepaint:((_this$_config4=this._config)===null||_this$_config4===void 0?void 0:_this$_config4.delayRepaint)===undefined?true:this._config.delayRepaint};const validate=(name,isZoom)=>{const val=this._config?this._config[name]:undefined;if(val!==undefined){const parsed=parseFloat(val);if(Number.isFinite(parsed)&&(!isZoom||parsed>=0&&parsed<=30)){res[name]=parsed;return}this._onWarning(external_kbnSharedDeps_KbnI18n_["i18n"].translate("visTypeVega.vegaParser.someKibanaConfigurationIsNoValidWarningMessage",{defaultMessage:"{configName} is not valid",values:{configName:"config.kibana.".concat(name)}}))}if(!isZoom)res[name]=0};validate("latitude",false);validate("longitude",false);validate("zoom",true);validate("minZoom",true);validate("maxZoom",true);res.mapStyle=((_this$_config5=this._config)===null||_this$_config5===void 0?void 0:_this$_config5.mapStyle)===undefined?"default":this._config.mapStyle;if(res.mapStyle!=="default"&&res.mapStyle!==false){this._onWarning(external_kbnSharedDeps_KbnI18n_["i18n"].translate("visTypeVega.vegaParser.mapStyleValueTypeWarningMessage",{defaultMessage:"{mapStyleConfigName} may either be {mapStyleConfigFirstAllowedValue} or {mapStyleConfigSecondAllowedValue}",values:{mapStyleConfigName:"config.kibana.mapStyle",mapStyleConfigFirstAllowedValue:"false",mapStyleConfigSecondAllowedValue:'"default"'}}));res.mapStyle="default"}this._parseBool("zoomControl",res,true);this._parseBool("scrollWheelZoom",res,false);const maxBounds=(_this$_config6=this._config)===null||_this$_config6===void 0?void 0:_this$_config6.maxBounds;if(maxBounds!==undefined){if(!Array.isArray(maxBounds)||maxBounds.length!==4||!maxBounds.every(v=>typeof v==="number"&&Number.isFinite(v))){this._onWarning(external_kbnSharedDeps_KbnI18n_["i18n"].translate("visTypeVega.vegaParser.maxBoundsValueTypeWarningMessage",{defaultMessage:"{maxBoundsConfigName} must be an array with four numbers",values:{maxBoundsConfigName:"config.kibana.maxBounds"}}))}else{res.maxBounds=maxBounds}}return res}_parseBool(paramName,dstObj,dflt){const val=this._config?this._config[paramName]:undefined;if(val===undefined){dstObj[paramName]=dflt}else if(typeof val!=="boolean"){this._onWarning(external_kbnSharedDeps_KbnI18n_["i18n"].translate("visTypeVega.vegaParser.someKibanaParamValueTypeWarningMessage",{defaultMessage:"{configName} must be a boolean value",values:{configName:"config.kibana.".concat(paramName)}}));dstObj[paramName]=dflt}else{dstObj[paramName]=val}}parseSchema(spec){const schema=parser_default()(spec.$schema);const isVegaLite=schema.library==="vega-lite";const libVersion=isVegaLite?vega["b"].version:vega["a"].version;if(compare_versions_default()(schema.version,libVersion)>0){this._onWarning(external_kbnSharedDeps_KbnI18n_["i18n"].translate("visTypeVega.vegaParser.notValidLibraryVersionForInputSpecWarningMessage",{defaultMessage:"The input spec uses {schemaLibrary} {schemaVersion}, but current version of {schemaLibrary} is {libraryVersion}.",values:{schemaLibrary:schema.library,schemaVersion:schema.version,libraryVersion:libVersion}}))}return{isVegaLite:isVegaLite,libVersion:libVersion}}_resolveDataUrls(){var _this3=this;return vega_parser_asyncToGenerator(regeneratorRuntime.mark((function _callee3(){var serviceSettings,onWarn,pending,pendingParsers;return regeneratorRuntime.wrap((function _callee3$(_context3){while(1)switch(_context3.prev=_context3.next){case 0:if(_this3._urlParsers){_context3.next=6;break}_context3.next=3;return _this3.getServiceSettings();case 3:serviceSettings=_context3.sent;onWarn=_this3._onWarning.bind(_this3);_this3._urlParsers={elasticsearch:new es_query_parser_EsQueryParser(_this3.timeCache,_this3.searchAPI,_this3.filters,onWarn),emsfile:new ems_file_parser_EmsFileParser(serviceSettings),url:new url_parser_UrlParser(onWarn)};case 6:pending={};_this3.searchAPI.resetSearchStats();_this3._findObjectDataUrls(_this3.spec,obj=>{const url=obj.url;delete obj.url;let type=url["%type%"];delete url["%type%"];if(type===undefined){type=DEFAULT_PARSER}const parser=_this3._urlParsers[type];if(parser===undefined){throw new Error(external_kbnSharedDeps_KbnI18n_["i18n"].translate("visTypeVega.vegaParser.notSupportedUrlTypeErrorMessage",{defaultMessage:"{urlObject} is not supported",values:{urlObject:'url: {"%type%": "${type}"}'}}))}let pendingArr=pending[type];if(pendingArr===undefined){pending[type]=pendingArr=[]}pendingArr.push(parser.parseUrl(obj,url))});pendingParsers=Object.keys(pending);if(!(pendingParsers.length>0)){_context3.next=13;break}_context3.next=13;return Promise.all(pendingParsers.map(type=>_this3._urlParsers[type].populateData(pending[type])));case 13:case"end":return _context3.stop()}}),_callee3)})))()}_findObjectDataUrls(obj,onFind,key){if(Array.isArray(obj)){var _iterator=vega_parser_createForOfIteratorHelper(obj),_step;try{for(_iterator.s();!(_step=_iterator.n()).done;){const elem=_step.value;this._findObjectDataUrls(elem,onFind,key)}}catch(err){_iterator.e(err)}finally{_iterator.f()}}else if(external_kbnSharedDeps_Lodash_default.a.isPlainObject(obj)){if(key==="data"&&external_kbnSharedDeps_Lodash_default.a.isPlainObject(obj.url)){if(obj.values!==undefined||obj.source!==undefined){throw new Error(external_kbnSharedDeps_KbnI18n_["i18n"].translate("visTypeVega.vegaParser.dataExceedsSomeParamsUseTimesLimitErrorMessage",{defaultMessage:"Data must not have more than one of {urlParam}, {valuesParam}, and {sourceParam}",values:{urlParam:'"url"',valuesParam:'"values"',sourceParam:'"source"'}}))}onFind(obj)}else{for(var _i=0,_Object$keys=Object.keys(obj);_i<_Object$keys.length;_i++){const k=_Object$keys[_i];this._findObjectDataUrls(obj[k],onFind,k)}}}}_setDefaultColors(){this._setDefaultValue({scheme:"elastic"},"config","range","category");if(this.isVegaLite){this._setDefaultValue(defaultColor,"config","mark","color")}else{var _this$spec;if(!((_this$spec=this.spec)===null||_this$spec===void 0?void 0:_this$spec.config.mark)||this.spec.config.mark.color===undefined&&this.spec.config.mark.fill===undefined){this._setDefaultValue(defaultColor,"config","arc","fill");this._setDefaultValue(defaultColor,"config","area","fill");this._setDefaultValue(defaultColor,"config","line","stroke");this._setDefaultValue(defaultColor,"config","path","stroke");this._setDefaultValue(defaultColor,"config","rect","fill");this._setDefaultValue(defaultColor,"config","rule","stroke");this._setDefaultValue(defaultColor,"config","shape","stroke");this._setDefaultValue(defaultColor,"config","symbol","fill");this._setDefaultValue(defaultColor,"config","trail","fill")}}this._setDefaultValue(external_kbnSharedDeps_Theme_["euiThemeVars"].euiColorDarkestShade,"config","title","color");this._setDefaultValue(external_kbnSharedDeps_Theme_["euiThemeVars"].euiColorDarkShade,"config","style","guide-label","fill");this._setDefaultValue(external_kbnSharedDeps_Theme_["euiThemeVars"].euiColorDarkestShade,"config","style","guide-title","fill");this._setDefaultValue(external_kbnSharedDeps_Theme_["euiThemeVars"].euiColorDarkestShade,"config","style","group-title","fill");this._setDefaultValue(external_kbnSharedDeps_Theme_["euiThemeVars"].euiColorDarkestShade,"config","style","group-subtitle","fill");this._setDefaultValue(external_kbnSharedDeps_Theme_["euiThemeVars"].euiColorChartLines,"config","axis","tickColor");this._setDefaultValue(external_kbnSharedDeps_Theme_["euiThemeVars"].euiColorChartLines,"config","axis","domainColor");this._setDefaultValue(external_kbnSharedDeps_Theme_["euiThemeVars"].euiColorChartLines,"config","axis","gridColor");this._setDefaultValue("transparent","config","background")}_setDefaultValue(value,...fields){let o=this.spec;for(let i=0;i<fields.length-1;i++){const field=fields[i];const subObj=o[field];if(subObj===undefined){o[field]={}}else if(!external_kbnSharedDeps_Lodash_default.a.isPlainObject(subObj)){return}o=o[field]}const lastField=fields[fields.length-1];if(o[lastField]===undefined){o[lastField]=value}}_onWarning(...args){if(!this.hideWarnings){this.warnings.push(utils["a"].formatWarningToStr(args));return utils["a"].formatWarningToStr(args)}}}}}]);